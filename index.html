<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <div class="media">
            <div class="header">
                <div class="header-avatar">
                    <img src="/assets/images/thao_linh.jpg" alt="">
                </div>
                <div class="tool">
                    <div class="navigation row justify-content-evenly">
                        <div class="content-icon btn-random" title="Phát ngẫu nhiên">
                            <i class="bi bi-shuffle"></i>
                        </div>
                        <div class="content-icon btn-previous" title="Bài hát trước đó">
                            <i class="bi bi-skip-start-fill"></i>
                        </div>
                        <div class="content-icon btn-play">
                            <i class="bi bi-play" title="Phát nhạc"></i>
                            <i class="bi bi-pause-fill" title="Dừng lại"></i>
                        </div>
                        <div class="content-icon btn-next" title="Bài hát kế tiếp">
                            <i class="bi bi-skip-end-fill"></i>
                        </div>
                        <div class="content-icon btn-repeat" title="Bật phát lại tất cả">
                            <i class="bi bi-repeat"></i>
                        </div>
                    </div>
                    <div class="srollbar">
                        <input type="range" class="progress" min="0" max="10000" value="0" />
                        <audio controls hidden id="audio" src="/assets/radio/CoLeBenNhauLaSaiSpeedUp.mp3">
                          </audio>
                    </div>
                </div>
            </div>
            <div class="song-list" id="song-list"></div>
        </div>
    </div>
    
    <script>
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        const audio = $('#audio');
        const btnPlay = $('.btn-play');
        const btnNext = $('.btn-next');
        const btnPrevious = $('.btn-previous');
        var songList = $('#song-list');
        const progress = $('.progress');
        const headerAvatar = $('.header-avatar');
        const btnRepeat = document.querySelector('.btn-repeat');
        const btnRandom = document.querySelector('.btn-random');
        const songs = [
            {
                songName: 'Có lẽ bên nhau là sai',
                singer: 'thaolinh, ViAM',
                link: '/assets/images/thao_linh.jpg',
                src: '/assets/radio/CoLeBenNhauLaSaiSpeedUp.mp3'
            },
            {
                songName: 'Thương biệt ly',
                singer: 'Oanh Tạ',
                link: '/assets/images/oanh_ta.jpg',
                src: '/assets/radio/ThuongBietLy.mp3'
            },
            {
                songName: 'Nevada',
                singer: 'Vicetone',
                link: '/assets/images/vicetone.jpg',
                src: '/assets/radio/Nevada.mp3'
            },
            {
                songName: 'Giá như chưa từng quen',
                singer: 'Vicetone',
                link: '/assets/images/vicetone.jpg',
                src: '/assets/radio/GiaNhuChuaTungQuen.mp3'
            }
        ];
        
        let media = {
            isPlay: false,
            isHoverProgress: false,
            isRepeat: false,
            isRandom: false,
            songs,
            currentSong: 0,
            render () {
                let html = '';
                for(index in songs){
                    html += `
                    <div class="item" data-index="${index}">
                        <div class="info">
                            <div class="avatar">
                                <img src="${songs[index].link}" alt="">
                            </div>
                            <b>${songs[index].songName}</b>
                            <div class="singer">${songs[index].singer}</div>
                        </div>
                    </div>
                    `;
                }
                songList.innerHTML = html;
            },
            handleEvents (){
                const _this = this;
                btnPlay.onclick = function () {
                    _this.setSongActive();
                    if(_this.isPlay == false){
                        audio.play();
                    } else {
                        this.classList.remove('playing');
                        audio.pause();
                    }
                }
                audio.onended = function() {
                    if (_this.isRepeat) {
                        _this.currentSong++;
                        if(_this.currentSong >= songs.length){
                            _this.currentSong = 0;
                        }
                        if(_this.isRandom){
                            var index = _this.currentSong;
                            do {
                                index = Math.floor(Math.random() * songs.length);
                            }
                            while(index == _this.currentSong)
                            console.log(_this.currentSong);
                            _this.currentSong = index;
                        }
                    }
                    _this.startCurrentSong();
                }
                audio.onplay = function () {
                    btnPlay.classList.add('playing');
                    localStorage.setItem("songIndex", _this.currentSong);
                    _this.isPlay = true;
                }
                audio.onpause = function () {
                    btnPlay.classList.remove('playing');
                    _this.isPlay = false;
                }

                audio.ontimeupdate = function () {
                    if(_this.isHoverProgress == false) {
                        progress.value = 10000/(this.duration/this.currentTime);
                    }
                }
                progress.onchange = function () {
                    _this.isHoverProgress = false;
                    audio.currentTime = Number.parseFloat(progress.value) * audio.duration/10000
                }
                progress.oninput = function () {
                    _this.isHoverProgress = true;
                }
                btnNext.onclick = function () {
                    _this.currentSong++;
                    if(_this.currentSong >= songs.length){
                        _this.currentSong = 0;
                    }
                    _this.startCurrentSong();
                }
                btnPrevious.onclick = function () {
                    _this.currentSong--;
                    if(_this.currentSong < 0){
                        _this.currentSong = songs.length - 1;
                    }
                    _this.startCurrentSong();
                }
                Array.from(songList.querySelectorAll('.item')).forEach(function (item) {
                    item.addEventListener('click', function (e) {
                        console.log(e.currentTarget);
                        _this.currentSong = Number.parseInt(e.currentTarget.dataset.index);
                        _this.startCurrentSong();
                    });
                });
                btnRepeat.onclick = function () {
                    _this.isRepeat = !_this.isRepeat;
                    if (_this.isRepeat) {
                        localStorage.setItem('isRepeat', true);
                        this.classList.add('active');
                    } else {
                        localStorage.setItem('isRepeat', false);
                        this.classList.remove('active');
                    }
                }
                btnRandom.onclick = function () {
                    _this.isRandom = !_this.isRandom;
                    if (_this.isRandom) {
                        this.classList.add('active');
                        localStorage.setItem('isRandom', true);
                    } else {
                        localStorage.setItem('isRandom', false);
                        this.classList.remove('active');
                    }
                }
                
            },
            startCurrentSong () {
                let currentData = this.songs[this.currentSong];
                audio.src = currentData.src;
                console.log(audio.readyState);
                    audio.play();
                this.setSongActive();
            },
            getCurrentSong () {
                let index = Number.parseInt(localStorage.getItem("songIndex"));
                if (index >= 0) {
                    this.currentSong = index;
                }
            },
            getConfig () {
                let isRandom = localStorage.getItem('isRandom');
                let isRepeat = localStorage.getItem('isRepeat');
                if(isRandom == 'true') {
                    btnRandom.classList.add('active');
                    this.isRandom = true;
                }
                if(isRepeat == 'true') {
                    btnRepeat.classList.add('active');
                    this.isRepeat = true;
                }
            },
            setSongActive() {
                let currentSong = songList.querySelector('.item.active');
                if(currentSong){
                    currentSong.classList.remove('active');
                }
                songList.querySelector(`[data-index="${this.currentSong}"]`).classList.add('active')
            }
            ,
            start() {
                this.render();
                this.getConfig();
                this.handleEvents();
                this.getCurrentSong();
                this.startCurrentSong();
                // this.startCurrentSong();
            }
        }
        media.start();
    </script>
</body>
</html>